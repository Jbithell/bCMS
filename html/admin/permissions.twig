{% extends "assets/template.twig" %}

{% block content %}

<div class="row">
	<div class="col-lg-12">
		<div class="box">
			<div class="box-header">
				<h3 class="box-title">Permissions</h3>
			</div>
			<div class="box-body table-responsive no-padding" style="overflow-x: scroll;">
				<table class="table table-striped sticky-header" >
					<thead>
						<tr>
							<th></th>
							<th></th>
							{% for position in positions %}
							<th>{{position.name}}</th>
							{% endfor %}
						</tr>
					</thead>
					<tbody>
						{% for category in features %}
							<tr>
								<td colspan="{{ 2+positions|length }}"><h3>{{ category.category.features_categories_name }}</h3></td>
							</tr>
							{% for feature in category.features %}
								<tr>
									<td>{{feature.id}}</td>
									<td>{{feature.name}}</td>
									{% for position in positions %}
                                        {% set positioncannotbecausedep = "false" %}
                                        {% set positioncannotbecauseindep = "false" %}
									<td>
                                        {% for dependentfeatureid in feature.dependent|split(',') %}
                                            {% if dependentfeatureid != "" and dependentfeatureid not in position.permissions|split(',') %}
												<small class="label label-warning" title="Requires other permission to be set first">{{ dependentfeatureid }}</small>
                                                {% set positioncannotbecausedep = "true" %}
                                            {% endif %}
                                        {% endfor %}
                                        {% for independentfeatureid in feature.incompatible|split(',') %}
                                            {% if independentfeatureid != "" and independentfeatureid in position.permissions|split(',') %}
												<small class="label label-danger" title="Requires other permission to be removed first">{{ independentfeatureid }}</small>
                                                {% set positioncannotbecauseindep = "true" %}
                                            {% endif %}
                                        {% endfor %}

										{% if 52|permissions %}
                                        <input type="checkbox" data-permissionid="{{feature.id}}" data-positionid="{{position.id}}" {% if feature.id in position.permissions|split(',') %}checked{% endif %}  {% if positioncannotbecausedep == "true" or positioncannotbecauseindep == "true" %}disabled{% endif %} />
										{% else %}
										   {% if feature.id in position.permissions|split(',') %}
											   <i class="fa fa-check-square-o"></i>
											{% else %}
												<i class="fa fa-square-o"></i>
											{% endif %}
										{% endif %}
									</td>
								{% endfor %}
							{% endfor %}
						</tr>
					{% endfor %}
					</tbody>
				</table>
			</div>
			<div class="overlay" id="loading">
				<i class="fa fa-refresh fa-spin"></i>
			</div>
		</div>
	</div>
</div>
{% if 52|permissions %}
<script>
$(document).ready(function() {
	$("#loading").hide();
	$(':checkbox').change(function() {
		$("#loading").show();
		if($(this).is(":checked")) {
			var get = "addpermission=" + $(this).data("permissionid");
		} else {
			var get = "removepermission=" + $(this).data("permissionid");
		}
		$.ajax({
			url: "{{CONFIG.ROOTURL}}/ajax/admin/permissions.php?" + get + "&position=" + $(this).data("positionid"),
			cache : false,
			success: function(result){
				if (result == '1') {
					$("#loading").hide();
                    location.reload();
				} else {
					bootbox.alert(result + "Sorry - Operation could not be completed! Please try again!", function() {
						location.reload();
					});
				}
			}
		});
	});
});
</script>
{% else %}
<script>
	$(document).ready(function() {
		$("#loading").hide();
	});
</script>
{% endif %}

{% endblock %}
